<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <!-- 手機版網頁 CSS Reset 螢幕解析度 Reset -->
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
        <title>浪潮情緒卡｜我的紀錄｜分析</title>
        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
        <!-- Bootstrap icon -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
        <!-- Bootstrap css -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        <link rel="stylesheet" href="./stylesheets/all.css">
    </head>
    <body>
        <header class="header h-logined fixed-top">
            <div class="container py-16 d-flex justify-content-between align-items-center">
                <h1>
                    <a href="index.html" data-bs-toggle="tooltip" data-bs-placement="bottom" title="回到首頁">浪潮情緒卡</a>
                </h1>
                <div class="d-lg-none position-relative">
                    <button class="px-8 py-4 btn btn-outline-main rounded-1" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                        <i class="bi bi-list"></i>
                    </button>
                    <div class="collapse" style="position: absolute; right: 0; top: 40px;" id="collapseExample">
                        <div class="p-0 card card-body rounded-2 border-2 border-main-tint01" style="width: 160px;">
                            <ul>
                                <li>
                                    <a class="d-block px-16 py-12 link-gray-600 btn-hover-main-tint02 rounded-2" href="aboutEmotions.html">認識情緒</a>
                                </li>
                                <li>
                                    <a class="d-block px-16 py-12 link-gray-600 btn-hover-main-tint02 rounded-2" href="findMyEmotions.html">探索情緒</a>
                                </li>
                                <li>
                                    <a class="d-block px-16 py-12 link-gray-600 btn-hover-main-tint02 rounded-2" href="myRecords.html">我的紀錄</a>
                                </li>
                                <!-- <li>
                                    <a class="d-block px-16 py-12 link-gray-600 btn-hover-main-tint02 rounded-2" href="sharedByOthers.html">他人的分享</a>
                                </li> -->
                                <li>
                                    <a class="d-block px-16 py-12 link-gray-600 btn-hover-main-tint02 rounded-2" href="account.html">我的帳戶</a>
                                </li>
                                <li>
                                  <div class="d-block px-16 py-12 link-gray-600 btn-hover-main-tint02 rounded-2" data-bs-toggle="modal" data-bs-target="#modalLogout" style="cursor: pointer;">登出</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <ul class="d-none d-lg-flex justify-content-between align-items-center mb-0 ps-0">
                    <li>
                        <a href="aboutEmotions.html" class="px-4 py-8" data-bs-toggle="tooltip" data-bs-placement="bottom" title="認識情緒與情緒卡">認識情緒</a>
                    </li>
                    <li class="ms-16">
                        <a href="findMyEmotions.html" class="px-4 py-8" data-bs-toggle="tooltip" data-bs-placement="bottom" title="選擇情緒卡與紀錄情緒">探索情緒</a>
                    </li>
                    <li class="ms-16">
                        <a href="myRecords.html" class="px-4 py-8" data-bs-toggle="tooltip" data-bs-placement="bottom" title="觀看我的紀錄與分析">我的紀錄</a>
                    </li>
                    <!-- <li class="ms-16">
                        <a href="sharedByOthers.html" class="px-4 py-8" data-bs-toggle="tooltip" data-bs-placement="bottom" title="觀看他人分享的情緒紀錄">他人的分享</a>
                    </li> -->
                    <li class="ms-16">
                        <a href="account.html" class="profile" data-bs-toggle="tooltip" data-bs-placement="bottom" title="管理我的帳戶">
                            <i class="bi bi-person-fill"></i>
                            <i class="bi bi-person-fill-gear"></i>
                        </a>
                    </li>
                    <li class="ms-16">
                      <a class="logout btn p-0 border-0" id="btnLogout" data-bs-toggle="tooltip" data-bs-placement="bottom" title="登出">
                          <i class="bi bi-door-closed-fill"></i>
                          <i class="bi bi-door-open-fill"></i>
                      </a>
                    </li>
                </ul>
            </div>
        </header>

        <main class="px-12 px-sm-0">
            <div class="container py-16 pt-112">
                <!-- 標題 -->
                <div class="mb-20 pb-8 border-2 border-bottom border-main-tint02 d-flex justify-content-between align-items-center" id="analyze-title">
                    <h2 class="fs-3">我的紀錄｜分析</h2>
                    <div class="nav-btn d-flex justify-content-end">
                        <a class="px-16 btn btn-outline-main c-btn" href="myRecords.html">紀錄</a>
                        <div class="ms-8 ms-sm-16 btn-disable text-nowrap">分析</div>
                    </div>
                </div>
                
                
                <!-- 搜尋條 & 分享 -->
                <form action="" method="get">
                    <!-- 搜尋條 -->
                    <div class="mb-md-24 d-flex flex-column flex-md-row justify-content-sm-between align-items-center" id="areaSearch">
                        <div class="box-analyze d-flex flex-column flex-md-row align-items-center" >
                            <div class="box-date-analyze d-flex flex-column flex-sm-row align-items-center mb-16 mb-md-0">
                                <input type="date" class="input-date-analyze d-block px-2 px-sm-16 py-6 border border-main-tint02 border-2 rounded-pill text-main-tint01 text-center" id="start_day" required />
                                <span class="mx-8 text-main-tint01">～</span>
                                <input type="date" class="input-date-analyze d-block me-md-12 px-2 px-sm-16 py-6 border border-main-tint02 border-2 rounded-pill text-main-tint01 text-center" id="end_day" required />
                            </div>
                            <div class="box-btn-analyze">
                                <button type="submit" class="w-100 btn btn-main c-btn px-24 py-8 border-0 text-nowrap" id="btnAnalyze">分析</button>
                            </div>
                        </div>
                        <!-- 分享 -->
                        <div class="d-none box-btn-analyze d-flex justify-content-end" id="btnDownload">
                            <button type="button" class="mt-12 mt-md-0 rounded-pill border-0 fs-4 c-btn-icon" data-bs-toggle="tooltip" data-bs-placement="bottom" title="下載圖檔">
                                <i class="bi bi-box-arrow-down"></i>
                            </button>
                        </div>
                    </div>
                </form>

                <!-- 圖表區 -->
                <div class="d-none px-12 px-sm-0 d-flex flex-column flex-lg-row justify-content-lg-between align-items-center align-items-lg-stretch mb-48" id="areaGraph">
                    <div class="box-47 mb-36 mb-lg-0">
                        <h3 class="mb-8 py-4 fs-5 fw-bold text-main border-bottom border-main-tint02">情緒類組次數</h3>
                        <p class="mb-4 text-gray-550">下圖為您在此期間記錄的情緒卡，在以下分類中所出現的次數的長條圖。</p>
                        <p class="mb-34 mb-sm-40 text-gray-550">若您想看該類別出現的次數，您可將游標停留在該類別的長條上。</p>
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="chart__bar-container position-relative">
                                <canvas id="barChart"></canvas>
                                <div class="position-absolute text-gray-550 chart__bar-unit">(次)</div>
                            </div>
                        </div>
                    </div>
                    <div class="box-47">
                        <h3 class="mb-8 py-4 fs-5 fw-bold text-main border-bottom border-main-tint02">情緒類組比例</h3>
                        <p class="mb-4 text-gray-550">下圖為您在此期間記錄的情緒卡，在以下分類中所出現的次數比例的圖餅圖。</p>
                        <p class="mb-34 mb-sm-40 text-gray-550">若您想看該類別所佔的比例，您可將游標停留在圓餅圖中該類別的色塊上。</p>
                        <div class="d-flex justify-content-center align-items-center custom-tooltip__doughnut-container">
                            <div class="chart__doughnut-container">
                                <canvas id="doughnutChart" class="position-relative"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fs-1 text-center d-none" id="no-data">這段期間沒有資料</div>

                <!-- 插畫 -->
                <div id="analyze-img">
                    <div class="px-12 px-sm-0 d-flex justify-content-end">
                        <img src="./images/lime-analyze.svg" alt="analyze" />
                    </div>
                    <!-- 圖片引用來源 -->
                    <div class="px-12 px-sm-0 text-end mb-48">
                        <span class="text-gray-500 fs-11">
                            Illustration by <a class="link-gray-500" href="https://icons8.com/illustrations/author/iAdLsFJOKDrk" target="_blank">Tanya Krasutska</a> from <a class="link-gray-500" href="https://icons8.com/illustrations" target="_blank">Ouch!</a>
                        </span>
                    </div>
                </div>
            </div>
        </main>

        <!-- 浮動按鈕 -->
        <div class="me-12 mb-12 floatButton">
            <a href="#top" type="button" class="btn btn-main-tint01 rounded-circle shadow d-flex flex-column justify-content-center align-items-center">
                <img class="d-none d-md-block" src="./images/backToTop.svg" alt="top">
                <span class="text-white fs-9 fs-md-10 fw-bold">TOP</span>
            </a>
        </div>
        
        <footer class="footer py-48">
            <div class="container">
                <div class="d-flex flex-column flex-lg-row align-items-center align-items-lg-start">
                    <!-- logo -->
                    <div class="footer-img mb-48 mb-lg-0 me-lg-96">
                        <img class="w-100" src="./images/logo_footer.svg" alt="logo">
                    </div>
                    <!-- Developers -->
                    <div class="footer-text-box mb-48 mb-lg-0 me-lg-56">
                        <h3 class="mb-16 fs-5">開發團隊</h3>
                        <ul>
                            <li class="mb-8">
                                <a class="d-lg-flex justify-content-between" href="https://www.linkedin.com/in/shu-ping-yu-238655268/"  target="_blank">
                                    <span>Project Manager</span>
                                    <span class="mt-4 d-block text-end">Shu-Ping Yu</span>
                                </a>
                            </li>
                            <li class="mb-8">
                                <a class="d-lg-flex justify-content-between" href="https://www.linkedin.com/in/shu-ping-yu-238655268/"  target="_blank">
                                    <span>Product Designer</span>
                                    <span class="mt-4 d-block text-end">Shu-Ping Yu</span>
                                </a>
                            </li>
                            <li class="mb-8">
                                <a class="d-lg-flex justify-content-between" href="https://www.linkedin.com/in/shu-ping-yu-238655268/" target="_blank">
                                    <span>Front-End Engineer</span>
                                    <span class="mt-4 d-block text-end">Shu-Ping Yu</span>
                                </a>
                            </li>
                            <li class="mb-8">
                                <a class="d-lg-flex justify-content-between" href="https://www.linkedin.com/in/%E5%81%89%E5%87%B1-%E6%9E%97-668aaa204/" target="_blank">
                                    <span>Front-End Consultant</span>
                                    <span class="mt-4 d-block text-end">Wei-Kai Lin</span>
                                </a>
                            </li>
                            <li class="mb-8">
                                <a class="d-lg-flex justify-content-between" href="https://www.linkedin.com/in/techleon/" target="_blank">
                                    <span>Database Developer</span>
                                    <span class="mt-4 d-block text-end">Leon Wu</span>
                                </a>
                            </li>
                            <li class="mb-8">
                                <a class="d-lg-flex justify-content-between" href="https://www.linkedin.com/in/techleon/" target="_blank">
                                    <span>Back-End Developer</span>
                                    <span class="mt-4 d-block text-end">Leon Wu</span>
                                </a>
                            </li>
                            <li class="mb-8">
                                <a class="d-lg-flex justify-content-between" href="https://www.linkedin.com/in/techleon/" target="_blank">
                                    <span>System Designer</span>
                                    <span class="mt-4 d-block text-end">Leon Wu</span>
                                </a>
                            </li>
                            <li>
                                <a class="d-lg-flex justify-content-between" href="https://a8607125167.wixsite.com/mysite/about"  target="_blank">
                                    <span>Illustrator</span>
                                    <span class="mt-4 d-block text-end">Yi-Wen Fang</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- Contact -->
                    <div class="footer-text-box mb-48 mb-lg-0 me-lg-56">
                      <div class="mb-48">
                        <a href="mailto:info@wavemocards.com">
                            <h3 class="mb-16 fs-5">聯絡我們</h3>
                            <span class="fs-8">點我寄信聯絡浪潮服務小組</span>
                        </a>
                      </div>
                      <div>
                        <a href="https://docs.google.com/forms/d/e/1FAIpQLSdiAQt45Pzuha3aj9OYdS-2-ljOcEcwEDwZjjls_ufdXHkQNw/viewform?usp=sharing"  target="_blank">
                            <h3 class="mb-16 fs-5">回報問題</h3>
                            <span class="fs-8">點我填寫回報問題表單</span>
                        </a>
                      </div>
                    </div>
                </div>
            </div>
        </footer>

        <!-- 確認登出 Modal -->
        <div class="modal fade" id="modalLogout" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4">
                    <div class="modal-body d-flex flex-column align-items-center px-48 pt-24 pb-16">
                        <p id="modalLogoutTitle" class="mb-12 fs-3 fw-bold text-pink">確定要登出嗎？</p>
                        <div style="width: 45%;">
                            <img class="w-100 pt-24 pb-2" src="./images/sureToDelete.svg" alt="img" id="modalLogoutImg">
                        </div>
                        <span class="text-gray-400 fs-11">Illustration by <a class="link-gray-400" href="https://blush.design/artists/RyUTVuP8G4QeAAEEQgug/pablo-stanley">Pablo Stanley</a> from <a class="link-gray-400" href="https://blush.design/">blush design</a></span>
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="button" id="modalLogoutClose" class="me-16 c-btn-outline-pink-tint01 fs-6" data-bs-dismiss="modal">取消</button>
                        <button type="button" id="modalLogoutSure" class="btn btn-pink c-btn px-24 py-8 link-white fs-6 rounded-pill">確定登出</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 使用期限到期，請重新登入 Modal -->
        <button type="button" id="btnTimeOut" class="d-none" data-bs-toggle="modal" data-bs-target="#modalTimeOut"></button>
        <div class="modal fade" id="modalTimeOut" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4">
                    <div class="modal-body d-flex flex-column align-items-center px-48 pt-24 pb-16">
                        <p id="modalTimeOutTitle" class="mb-12 fs-3 fw-bold text-pink">登入期限到期</p>
                        <p id="modalTimeOutText" class="mb-12 mt-12 fs-7 text-gray-700">不好意思，您的登入期限已到期，若想繼續使用，請重新登入。</p>
                        <div style="width: 45%;">
                            <img class="w-100 pt-24 pb-2" src="./images/addCardFail.svg" alt="img" id="modalTimeOutImg">
                        </div>
                        <span class="text-gray-400 fs-11">Illustration by <a class="link-gray-400" href="https://blush.design/artists/RyUTVuP8G4QeAAEEQgug/pablo-stanley">Pablo Stanley</a> from <a class="link-gray-400" href="https://blush.design/">blush design</a></span>
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <a href="login.html" id="modalTimeOutLink" class="btn btn-pink c-btn px-16 py-8 link-white fs-6 fw-bold">我知道了</a>
                    </div>
                </div>
            </div>
        </div>

        <!--  Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
        <!-- axios CDN -->
        <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
        <script src="./js/toolTips.js"></script>
        <script src="./js/pages/logout.js"></script>
        <script src="./js/timeOut.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
        <script>
            const authenticationTools = getTokenAndAccount()

            if (
                authenticationTools.token === "" ||
                authenticationTools.account === ""
            ) {
                logout()
            }

            const BASE_URL = "https://api.wavemocards.com"

            const btnAnalyze = document.querySelector("#btnAnalyze")
            const btnDownload = document.querySelector("#btnDownload")
            const areaSearch = document.querySelector("#areaSearch")
            const areaGraph = document.querySelector("#areaGraph")
            const analyzeImg = document.getElementById("analyze-img")
            const noData = document.getElementById("no-data")

            const startDayInput = document.getElementById("start_day")
            const endDayInput = document.getElementById("end_day")

            const doughnutChartCTX = document.getElementById("doughnutChart")
            const barChartCTX = document.getElementById("barChart")

            let prevDoughnutCanvasWidth = 0

            const printArea = document.querySelector("main")
            const printAreaCanvas = document.createElement('canvas')
            const printAreaCanvasCtx = printAreaCanvas.getContext('2d', { willReadFrequently: true });

            const idCardsLookupTable = {}

            let hasIdCardsLookupTableSettled = false
            let previousData = ""
            let currentData = null
            let correspondBackgroundColors = null

            const COLOR_LOOKUP_TABLE = {
                快樂: "#FFE589",
                期待: "#F8C18F",
                安心: "#CEE5AF",
                不安: "#C1A1A1",
                驚訝: "#B4B9E7",
                低落: "#C5DDE8",
                討厭: "#C0B3A6",
                生氣: "#E0AEAE",
                其他: "#EBEBEB"
            }

            let barChart = null
            let doughnutChart = null
            let doughnutCanvasWidth = 0

            btnAnalyze.addEventListener("click", async function () {
                event.preventDefault()

                if (!validateDateInput({
                    inputElement: startDayInput, 
                    errorMessage: "請輸入起使日期",
                    errorStyleClass: "border-pink-dark"
                })) {
                    return
                }

                if (!validateDateInput({
                    inputElement: endDayInput, 
                    errorMessage: "請輸入結束日期",
                    errorStyleClass: "border-pink-dark"
                })) {
                    return
                }

                if (
                    new Date(startDayInput.value) > new Date(endDayInput.value)
                ) {
                    startDayInput.classList.add("border-pink-dark")
                    endDayInput.classList.add("border-pink-dark")
                    alert("開始時間不可晚於結束時間")
                    return
                } else {
                    startDayInput.classList.remove("border-pink-dark")
                    endDayInput.classList.remove("border-pink-dark")
                }

                try {
                    btnAnalyze.disabled = true
                    btnAnalyze.textContent = "讀取"

                    if (!hasIdCardsLookupTableSettled) {
                        await fetchIdCardsLookupTable()
                        hasIdCardsLookupTableSettled = true
                    }

                    const fetchedData = await fetchAnalyzeResult({
                        start_day: startDayInput.value,
                        end_day: endDayInput.value
                    })

                    btnAnalyze.disabled = false
                    btnAnalyze.textContent = "分析"

                    if (JSON.stringify(fetchedData) !== previousData) {
                        previousData = JSON.stringify(fetchedData)

                        resetChart(barChart)
                        resetChart(doughnutChart)
                        resetCustomTooltips(doughnutChartCTX)
                        printAreaCanvasCtx.reset();

                        if (fetchedData.message) {
                            noData.classList.remove("d-none")
                            areaGraph.classList.add("d-none")
                            analyzeImg.classList.remove("d-none")
                            btnDownload.classList.add("d-none")
                            return
                        }

                        noData.classList.add("d-none")
                        currentData = arrangeData(
                            fetchedData,
                            idCardsLookupTable
                        )
                        correspondBackgroundColors = Object.keys(
                            currentData
                        ).map((each) => COLOR_LOOKUP_TABLE[each])

                        if (btnDownload.classList.contains("d-none")) {
                            btnDownload.classList.remove("d-none")
                        }

                        if (areaGraph.classList.contains("d-none")) {
                            areaGraph.classList.remove("d-none")
                        }

                        if (!analyzeImg.classList.contains("d-none")) {
                            analyzeImg.classList.add("d-none")
                        }

                        barChart = new Chart(barChartCTX, {
                            type: "bar",
                            data: {
                                labels: Object.keys(currentData),
                                datasets: [
                                    {
                                        label: "情緒類組次數",
                                        data: Object.values(currentData),
                                        backgroundColor:
                                            correspondBackgroundColors,
                                        borderRadius: 50,
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        bodyFont: {
                                            size: 16
                                        },
                                        callbacks: {
                                            title: () => '',
                                            label: (context) => {
                                                const { label, formattedValue } = context
                                                return `${label}: ${formattedValue} 次`
                                            },
                                        },
                                    }
                                },
                                scales: {
                                    x: {
                                        ticks: {
                                            font: {
                                                size: 16,
                                                weight: 700
                                            }
                                        },
                                        grid: {
                                            display: false
                                        },
                                        border: {
                                            color: "#313131",
                                            width: 2,
                                            z: 1
                                        }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1,
                                            font: {
                                                size: 16
                                            },
                                            padding: 4
                                        },
                                        border: {
                                            display: false
                                        },
                                        drawTicks: true,
                                        grid: {
                                            drawTicks: false
                                        }
                                    }
                                },
                                onResize(chart, newSize) {
                                    const { width } = newSize
                                    const unitEle = chart.canvas.nextElementSibling
                                    if (width < 400) {
                                        chart.data.datasets[0].barThickness = 20
                                        chart.options.scales.y.ticks.font.size = 12
                                        chart.options.scales.x.ticks.font.size = 12
                                        unitEle.style.fontSize = '12px'
                                    } else {
                                        chart.data.datasets[0].barThickness = 28
                                        chart.options.scales.y.ticks.font.size = 16
                                        chart.options.scales.x.ticks.font.size = 16
                                        unitEle.style.fontSize = '16px'
                                    }
                                },
                            }
                        })

                        doughnutChart = new Chart(doughnutChartCTX, {
                            type: "doughnut",
                            data: {
                                labels: Object.keys(currentData),
                                datasets: [
                                    {
                                        data: getPercentageArray(
                                            Object.values(currentData)
                                        ),
                                        backgroundColor:
                                            correspondBackgroundColors,
                                        cutout: "65%"
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                animation: {
                                    onProgress: () => {
                                        btnDownload.firstElementChild.disabled = true
                                        btnDownload.firstElementChild.classList.add("opacity-25")
                                    },
                                    onComplete: () => {
                                        html2canvas(printArea, {
                                            onclone: (document, printArea) => {
                                                const viewportWidth = document.documentElement.clientWidth;
                                                printArea.children[0].querySelector("#analyze-title").remove()
                                                printArea.querySelectorAll(".custom-tooltip").forEach(each => {
                                                    each.classList.remove("show-up");
                                                    const spans = each.querySelectorAll('span')
                                                    if (viewportWidth >= 768) {
                                                        spans[0].style.transform = each.querySelector('p').classList.contains("end") ? 'translate(-16px, -8px)' : 'translate(0px, -8px)';
                                                    } else if (viewportWidth >= 480) {
                                                        spans[0].style.transform = each.querySelector('p').classList.contains("end") ? 'translate(-8px, -4px)' : 'translate(0px, -4px)';
                                                    }
                                                })
                                                return printArea
                                            }
                                        }).then((canvas) => {
                                            const w = canvas.width;
                                            const h = canvas.height;
                                            
                                            printAreaCanvas.width = w;
                                            printAreaCanvas.height = h;
                                            printAreaCanvasCtx.drawImage(canvas, 0, 0, w, h, 0, 0, w, h);
                                            btnDownload.firstElementChild.disabled = false;
                                            btnDownload.firstElementChild.classList.remove("opacity-25")
                                        })
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        bodyFont: {
                                            size: 16
                                        },
                                        callbacks: {
                                            title: () => '',
                                            label: (context) => {
                                                const { label, formattedValue } = context
                                                return `${label}: ${formattedValue} %`
                                            }
                                        }
                                    }
                                },
                                onHover(event, chartArray) {
                                    if (chartArray.length !== 0 && event.type === "mousemove") {
                                        doughnutChartCTX.style.zIndex = "1"
                                        return
                                    }
                                    doughnutChartCTX.style.zIndex = "auto"
                                },
                                onResize(chart, newSize) {
                                    const currentWidth = Math.floor(newSize.width / 10) * 10
                                    const isRevised = prevDoughnutCanvasWidth !== currentWidth
                                    if (isRevised) {
                                        resetCustomTooltips(doughnutChartCTX)
                                    }
                                    if (currentData !== null && doughnutChart !== null && isRevised) {
                                        createTooltipsForDoughnutChart(
                                            currentData,
                                            doughnutChart,
                                        )
                                        prevDoughnutCanvasWidth = currentWidth
                                    }
                                }
                            }
                        })

                        createTooltipsForDoughnutChart(
                            currentData,
                            doughnutChart,
                        )

                    }
                } catch (error) {
                    console.log(error)
                    alert(error);
                }
            })

            btnDownload.addEventListener("click", function () {
                const strData = printAreaCanvas.toDataURL('png')
                const save_link = document.createElement('a')
                save_link.href = strData
                save_link.download = 'my-analyze.png'
                const event = new MouseEvent('click', {
                    "bubbles": false,
                    "cancelable":false
                });
                save_link.dispatchEvent(event);
            })

            function getTokenAndAccount() {
                const token = localStorage.getItem("token")
                const account = localStorage.getItem("account")
                if (!token || !account) {
                    logout({ token, account })
                    return
                }
                return { token, account }
            }

            function logout({ token, account }) {
                localStorage.removeItem(token)
                localStorage.removeItem(account)
                location.href = "login.html"
            }

            function validateDateInput({inputElement, errorMessage = '', errorStyleClass = ''}) {
                const { value } = inputElement
                if (value === '') {
                    inputElement.classList.add(errorStyleClass)
                    alert(errorMessage)
                    return false
                } else {
                    inputElement.classList.remove(errorStyleClass)
                    return true
                }
            }

            function getPercentageArray(integerArray) {
                const total = integerArray.reduce(
                    (accumulation, current) => (accumulation += current),
                    0
                )
                const resultArray = integerArray.map((num) => {
                    const decimal = (num / total) * 100
                    return Number(decimal.toFixed(2))
                })
                return resultArray
            }

            function getRadianArray(integerArray) {
                const total = integerArray.reduce(
                    (accumulation, current) => (accumulation += current),
                    0
                )
                let previousRadian = 0
                let returnRadian = 0
                const resultArray = integerArray.map((num) => {
                    const radian = num / total
                    returnRadian = Number(
                        (previousRadian + radian / 2).toFixed(2)
                    )
                    previousRadian += radian
                    return returnRadian
                })
                return resultArray
            }

            function createTooltipsForDoughnutChart(data, targetDoughnutChart) {
                if (!targetDoughnutChart.canvas) return
                let parentWidth = targetDoughnutChart.canvas.parentElement.parentElement.offsetWidth
                let canvasWidth = targetDoughnutChart.canvas.offsetWidth
                
                const radianArray = getRadianArray(Object.values(data))
                const percentageArray = getPercentageArray(Object.values(data))

                Object.keys(data).forEach((key, index) => {
                    const NINETY_DEGREE_RADIAN = 0.25
                    
                    if (percentageArray[index] > 10) {
                        const radian = radianArray[index] - NINETY_DEGREE_RADIAN
                        const tooltip = document.createElement("DIV")
                        const content = `
                            <p class="custom-tooltip__doughnut-content">
                                <span class="fw-700">${key}</span>
                                <span class="text-gray-550">
                                    ${percentageArray[index].toString() + "%"}
                                </span>
                            </p>
                        `
                        tooltip.insertAdjacentHTML("beforeend", content)
                        tooltip.classList.add("custom-tooltip", "custom-tooltip__doughnut", "show-up")

                        const radius = canvasWidth / 2

                        const x = Math.floor(Math.abs(radius * 0.825 * Math.cos(radian * 2 * Math.PI)))

                        const y = Math.floor(radius * 0.825 * Math.sin(radian * 2 * Math.PI))

                        tooltip.style.transform = `translateY(calc(-100% + ${y}px))`

                        if (determineIsRight(radian)) {
                            tooltip.firstElementChild.classList.add("end")
                            tooltip.style.left = `${x + parentWidth * 0.5}px`

                            if (parentWidth > 500) {
                                tooltip.style.right = '10%'
                            } else {
                                tooltip.style.right = 0
                            }
                        } else {
                            tooltip.style.right = `${x + parentWidth * 0.5}px`

                            if (parentWidth > 500) {
                                tooltip.style.left = '10%'
                            } else {
                                tooltip.style.left = 0
                            }
                        }

                        targetDoughnutChart.canvas.parentElement.insertAdjacentElement(
                            "beforeend",
                            tooltip
                        )
                    }
                })
            }

            function resetChart(chartVariable) {
                if (chartVariable !== null) {
                    chartVariable.destroy()
                    chartVariable = null
                }
            }

            function resetCustomTooltips(chartCTX) {
                const tooltips =
                    chartCTX.parentElement.querySelectorAll(".custom-tooltip")
                if (tooltips.length !== 0) {
                    tooltips.forEach((tooltip) => {
                        tooltip.remove()
                    })
                }
            }

            function determineIsRight(radian) {
                const ONE_FOURTH = 0.25
                const THREE_FOURTHS = 0.75
                return radian < ONE_FOURTH || radian >= THREE_FOURTHS
            }

            function arrangeData(fetchedData, lookupTable) {
                const returnData = {}
                Object.entries(fetchedData).map((each) => {
                    const [key, value] = each
                    if (returnData[lookupTable[key]] === undefined) {
                        returnData[lookupTable[key]] = value
                    } else {
                        returnData[lookupTable[key]] += value
                    }
                })
                return returnData
            }

            async function fetchIdCardsLookupTable() {
                try {
                    const response = await axios.get(
                        `${BASE_URL}/emoinfo/cards`
                    )
                    const { data } = response
                    if (data.error) {
                        throw new Error(data.error)
                    }
                    Object.entries(data).map((each) => {
                        const [key, value] = each
                        const { category } = value
                        idCardsLookupTable[key] = category
                    })
                } catch (error) {
                    alert(`錯誤訊息： ${error.message}。建議諮詢伺服器管理員`)
                }
            }

            async function fetchAnalyzeResult({
                start_day = "",
                end_day = ""
            }) {
                const { token, account: user_name } = getTokenAndAccount()
                try {
                    const response = await axios(
                        `${BASE_URL}/emotions/analysis`,
                        {
                            headers: { Authorization: `Bearer ${token}` },
                            params: {
                                user_name,
                                start_day,
                                end_day
                            }
                        }
                    )
                    if (response.status === 200) {
                        return response.data
                    } else {
                        throw new Error(response.data)
                    }
                } catch (error) {
                    alert(`錯誤訊息： ${error.message}。請確認是否有輸入錯誤，或者是諮詢伺服器管理員`)
                }
            }
        </script>
    </body>
</html>