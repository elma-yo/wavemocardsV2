<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <!-- 手機版網頁 CSS Reset 螢幕解析度 Reset -->
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
        <title>浪潮情緒卡｜重設密碼</title>
        <!-- Bootstrap icon -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
        <!-- Bootstrap css -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        <link rel="stylesheet" href="./stylesheets/all.css">
    </head>
    <body>
        <main  class="login d-flex justify-content-center align-items-stretch">
            <div class="box-resetPwd-text py-32 px-24 d-flex flex-column align-items-center">
                <div class="text-main d-flex flex-column align-items-center" style="font-size: 88px;">
                    <i class="bi bi-person-circle profile"></i>
                </div>
                <h2 class="w-100 mb-32 text-center text-main fs-2">重設密碼</h2>

                <div class="mb-32 w-100" id="areaEmail">
                    <label for="email" class="w-100 form-label  d-flex justify-content-between">
                        Email
                        <span class="text-pink-tint02 fs-9">*必填</span>
                    </label>
                    <input type="email" class="w-100 form-control rounded-pill px-20" id="email" placeholder="wavemocards@mail.com">
                    <div class="mt-4 ms-24 fs-9" id="emailCmt"></div>
                </div>
                <div class="mb-32 w-100" id="areaPinCode">
                    <label for="pinCode" class="w-100 form-label  d-flex justify-content-between">
                        驗證碼
                        <span class="text-pink-tint02 fs-9">*必填</span>
                    </label>
                    <input type="text" class="d-none w-100 form-control rounded-pill px-20" id="pinCode">
                    <div class="mt-4 ms-24 fs-9" id="pinCodeCmt"></div>
                </div>
                <div class="mb-32 w-100" id="areaPwd">
                    <label for="pwdNow" class="w-100 form-label  d-flex justify-content-between">
                        現在的密碼
                        <span class="text-pink-tint02 fs-9">*必填</span>
                    </label>
                    <input type="password" class="w-100 form-control rounded-pill px-20" id="pwdNow">
                    <div class="mt-4 ms-24 fs-9" id="pwdNowCmt"></div>
                    <label for="pwdNew" class="w-100 mt-20 form-label  d-flex justify-content-between">
                        新的密碼
                        <span class="text-pink-tint02 fs-9">*必填</span>
                    </label>
                    <input type="password" class="w-100 form-control rounded-pill px-20" id="pwdNew">
                    <div class="mt-4 ms-24 fs-9" id="pwdNewCmt"></div>
                    <button class="ms-24 p-0 fs-9 link-gray-550 bg-white border-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePwdRules" aria-expanded="false" aria-controls="collapsePwdRules">
                        點我看 設定密碼規則
                    </button>
                    <!-- collapse 卡片內容 -->
                    <div class="collapse ms-12 ms-sm-24" id="collapsePwdRules">
                        <div class="card card-body py-8 bg-gray-200 border-0 rounded-2">
                            <ol class="fs-9">
                                <li class="ms-16">包含<span class="fw-bold"> 8 ~ 16 </span>個字符。</li>
                                <li class="ms-16">至少包含<span class="fw-bold"> 1 個英文字母</span>(A-Z或a-z)。</li>
                                <!-- <li class="ms-16">至少包含<span class="fw-bold"> 1 個大寫 </span>字母（A-Z）。</li>
                                <li class="ms-16">至少包含<span class="fw-bold"> 1 個小寫 </span>字母（a-z）。</li> -->
                                <li class="ms-16">至少包含<span class="fw-bold"> 1 個數字 </span>（0-9）。</li>
                                <!-- <li class="ms-16">至少包含<span class="fw-bold"> 1 個特殊字符 </span>（例如！、@、#、$、%等）。</li> -->
                            </ol>
                        </div>
                    </div>
                    <label for="pwdNew2" class="w-100 mt-20 form-label  d-flex justify-content-between">
                        2次輸入新的密碼
                        <span class="text-pink-tint02 fs-9">*必填</span>
                    </label>
                    <input type="password" class="w-100 form-control rounded-pill px-20" id="pwdNew2">
                    <div class="mt-4 ms-24 fs-9" id="pwdNew2Cmt"></div>
                </div>
                <button class="w-100 mb-32 py-8 btn btn-main c-btn" type="button" id="btnSubmitEmail" data-bs-toggle="modal" data-bs-target="#staticBackdrop">送出</button>
                <button class="w-100 mb-32 py-8 btn btn-main c-btn" type="button" id="btnSubmitPinCode" data-bs-toggle="modal" data-bs-target="#modalPinCodeResult">送出驗證碼</button>
                <button class="w-100 mb-32 py-8 btn btn-main c-btn" type="button" id="btnSubmitPwd">重設密碼</button>

                <a class="mb-16 d-block w-100 clickMeToBack cursor-pointer" id="btnBack">返回</a>
            </div>
        </main>

        <button type="button" class="d-none" id="btnResetResult" data-bs-toggle="modal" data-bs-target="#modalResetResult"></button>

        <!-- email送出後的 Modal -->
        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content rounded-3">
                <div class="modal-header">
                <h5 class="modal-title px-8 fs-5" id="staticBackdropLabel">請查看你的電子信箱</h5>
                </div>
                <div class="modal-body px-24">
                    <p>我們已經發送一封重設密碼通知信到</p>
                    <p class="text-main fs-7 fw-bold">elmaspy@gmail.com</p>
                    <p>請點擊信件中的連結進行修改密碼，如果沒有收到，請檢查你的垃圾郵件或再試一次忘記密碼！</p>
                </div>
                <div class="modal-footer">
                <a class="btn btn-main link-white" href="login.html">重新登入</a>
                </div>
            </div>
            </div>
        </div>

        <!-- 重設密碼 成功/失敗 Modal -->
        <div class="modal fade" id="modalResetResult" data-bs-backdrop="static" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-body d-flex flex-column align-items-center px-48 py-36">
                    <p id="modalResetResultTitle" class="fs-4 fw-bold">重設密碼成功</p>
                    <p id="modalResetResultText" class="d-none mt-12 fs-7 text-gray-700">很抱歉重設密碼失敗，請確認是否有輸入正確的「現在的密碼」以及「新的密碼」是否有符合設定密碼規則。</p>
                    <p id="modalResetResultText2" class="d-none mt-12 fs-7 text-gray-700">
                        若無法排除問題，請 
                        <a class="link-pink" href="mailto:info@wavemocards.com">與我們聯繫</a>
                    </p>
                    <div style="width: 45%; height: 45%;">
                        <img class="w-100" src="./images/emoCards/5.svg" alt="img" id="modalResetResultImg">
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" id="modalResetResultClose" class="d-none btn btn-pink c-btn px-36 py-8 link-white fs-6 fw-bold" data-bs-dismiss="modal">我知道了</button>
                    <a id="modalResetResultLink" class="btn btn-main c-btn px-36 py-8 link-white fs-6 fw-bold cursor-pointer">重新登入</a>
                </div>
            </div>
            </div>
        </div>

        <!--  Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
        <!-- axios -->
        <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>
        <script type="text/javascript" src="./js/formValidation.js"></script>
        <script>
            const areaEmail = document.querySelector("#areaEmail");
            const areaPinCode = document.querySelector("#areaPinCode");
            const areaPwd = document.querySelector("#areaPwd");
            const email = document.querySelector("#email");
            const btnSubmitEmail = document.querySelector("#btnSubmitEmail");
            const emailCmt = document.querySelector("#emailCmt");
            const pinCode = document.querySelector("#pinCode");
            const btnSubmitPinCode = document.querySelector("#btnSubmitPinCode");
            const pinCodeCmt = document.querySelector("#pinCodeCmt");
            const pwdNow = document.querySelector("#pwdNow");
            const pwdNew = document.querySelector("#pwdNew");
            const pwdNew2 = document.querySelector("#pwdNew2");
            const pwdNowCmt = document.querySelector("#pwdNowCmt");
            const pwdNewCmt = document.querySelector("#pwdNewCmt");
            const pwdNew2Cmt = document.querySelector("#pwdNew2Cmt");
            const btnSubmitPwd = document.querySelector("#btnSubmitPwd");
            const btnResetResult = document.querySelector("#btnResetResult");
            const btnBack = document.querySelector("#btnBack");
            // modal
            const modalResetResult = document.querySelector("#modalResetResult");
            const modalResetResultTitle = document.querySelector("#modalResetResultTitle");
            const modalResetResultText = document.querySelector("#modalResetResultText");
            const modalResetResultText2 = document.querySelector("#modalResetResultText2");
            const modalResetResultImg = document.querySelector("#modalResetResultImg");
            const modalResetResultClose = document.querySelector("#modalResetResultClose");
            const modalResetResultLink = document.querySelector("#modalResetResultLink");
            // 取得token
            let token = localStorage.getItem("token");
            if(token!=null){
                areaEmail.classList.add("d-none");
                btnSubmitEmail.classList.add("d-none");
                areaPinCode.classList.add("d-none");
                btnSubmitPinCode.classList.add("d-none");
                areaPwd.classList.remove("d-none");
                btnSubmitPwd.classList.remove("d-none");
            } else {
                areaEmail.classList.remove("d-none");
                btnSubmitEmail.classList.remove("d-none");
                areaPinCode.classList.add("d-none");
                btnSubmitPinCode.classList.add("d-none");
                areaPwd.classList.add("d-none");
                btnSubmitPwd.classList.add("d-none");
            }

            // 設定 返回 按鈕的location
            let backLocation = localStorage.getItem("resetPwdBackLocation");
            btnBack.addEventListener("click", function(){
                location.href = backLocation;
            })

            // 前端驗證 email 格式
            let emailFrontEndVerified = false;
            let emailBackEndVerified = false;
            email.addEventListener("keyup", function(){
                emailValue = email.value;
                if(finalEmail==undefined || finalEmail!=emailValue) {
                    let correct = IsEmail(emailValue);
                    if (correct==false) {
                        emailCmt.textContent = "請輸入正確的 Email 格式";
                        emailCmt.classList.add("text-pink");
                        emailFrontEndVerified = false;
                    } else {
                        emailCmt.textContent = "";
                        emailFrontEndVerified = true;
                    }
                }
            })
            email.addEventListener("click", function(){
                emailValue = email.value;
                emailValue = email.value;
                if(finalEmail==undefined || finalEmail!=emailValue) {
                    let correct = IsEmail(emailValue);
                    if (correct==false) {
                        emailCmt.textContent = "請輸入正確的 Email 格式";
                        emailCmt.classList.add("text-pink");
                        emailFrontEndVerified = false;
                    } else {
                        emailCmt.textContent = "";
                        emailFrontEndVerified = true;
                    }
                }
            })
            // 後端驗證 email
            btnSubmitEmail.addEventListener("click", function(){
                if(emailFrontEndVerified==true){

                }
            })
            function IsEmail(email) {
                var regex = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
                if(!regex.test(email)) {
                    return false;
                }else{
                    return true;
                }
            }

            // 前端驗證 password 格式
            let pwdNowCorrect = false;
            // 驗證 現在的密碼 是否符合 密碼規則
            pwdNow.addEventListener("keyup", function(){
                let pwdRegex = /(?![0-9]+$)(?![a-zA-z]+$)[0-9A-za-z]{8,16}/;
                if(!pwdRegex.test(pwdNow.value)){
                    pwdNowCmt.textContent = "您的密碼不符合密碼規則，請重新設定密碼";
                    pwdNowCmt.style.color = "#C37979";
                    pwdNowCorrect = false;
                } else {
                    pwdNowCmt.innerHTML = `<i class="bi bi-check-circle-fill"></i>`;
                    pwdNowCmt.style.color = "#3C9DAE";
                    pwdNowCorrect = true;
                }
            })
            // 驗證 新密碼 是否符合 密碼規則
            let pwdNewCorrect = false;
            pwdNew.addEventListener("keyup", function(){
                let pwdRegex = /(?![0-9]+$)(?![a-zA-z]+$)[0-9A-za-z]{8,16}/;
                if(!pwdRegex.test(pwdNew.value)){
                    pwdNewCmt.textContent = "您的密碼不符合密碼規則，請重新設定密碼";
                    pwdNewCmt.style.color = "#C37979";
                    pwdNewCorrect = false;
                } else {
                    pwdNewCmt.innerHTML = `<i class="bi bi-check-circle-fill"></i>`;
                    pwdNewCmt.style.color = "#3C9DAE";
                    pwdNewCorrect = true;
                }
            })
            // 監聽 pwd & pwd ，並且驗證兩者密碼是否相同
            let pwdNew2Correct = false;
            pwdNew.addEventListener("keyup", pwdVerify)
            pwdNew2.addEventListener("keyup", pwdVerify)
            function pwdVerify(){
                if(pwdNew.value != "" && pwdNew2.value != "" && pwdNew.value == pwdNew2.value) {
                    pwdNew2Cmt.innerHTML = `<i class="bi bi-check-circle-fill"></i>`;
                    pwdNew2Cmt.style.color = "#3C9DAE";
                    pwdNew2Correct = true;
                } else if(pwdNew.value != "" && pwdNew2.value != "" && pwdNew.value != pwdNew2.value) {
                    pwdNew2Cmt.textContent = "密碼有誤，請輸入與新密碼相同的密碼";
                    pwdNew2Cmt.style.color = "#C37979";
                    pwdNew2Correct = false;
                } else if (pwdNew.value == "") {
                    pwdNew2Cmt.textContent = "";
                    pwdNew2Correct = false;
                }
            }

            btnSubmitPwd.addEventListener("click", function(){
                if(pwdNowCorrect==true && pwdNewCorrect==true && pwdNew2Correct==true) {
                    let postData = {
                        "current_password": pwdNow.value,
                        "new_password": pwdNew.value,
                        "confirm_password": pwdNew2.value,
                    }
                    axios.put("https://api.wavemocards.com/user/password",
                    postData, { headers: {"Authorization": `Bearer ${token}`} })
                    .then(function(response){
                        if(response.data.message == "The password was successfully updated."){
                            modalResetResultTitle.textContent = "重設密碼成功";
                            modalResetResultTitle.classList.add("text-main");
                            modalResetResultTitle.classList.remove("text-pink");
                            modalResetResultText.classList.add("d-none");
                            modalResetResultText2.classList.add("d-none");
                            modalResetResultImg.src = "./images/emoCards/5.svg";
                            modalResetResultClose.classList.add("d-none");
                            modalResetResultLink.classList.remove("d-none");
                            btnResetResult.click();
                        } else if(response.data.error == "The new password should not be the same as the current password!") {
                            modalResetResultTitle.textContent = "重設密碼失敗";
                            modalResetResultTitle.classList.remove("text-main");
                            modalResetResultTitle.classList.add("text-pink");
                            modalResetResultText.textContent = "新的密碼不可以和舊的密碼相同喔！請修正後再重新重設密碼。"
                            modalResetResultText.classList.remove("d-none");
                            modalResetResultText2.classList.add("d-none");
                            modalResetResultImg.src = "./images/emoCards/58.svg";
                            modalResetResultClose.classList.remove("d-none");
                            modalResetResultLink.classList.add("d-none");
                            btnResetResult.click();
                        } else {
                            modalResetResultTitle.textContent = "重設密碼失敗";
                            modalResetResultTitle.classList.remove("text-main");
                            modalResetResultTitle.classList.add("text-pink");
                            modalResetResultText.textContent = "很抱歉重設密碼失敗，請確認是否有輸入正確的「現在的密碼」以及「新的密碼」是否有符合設定密碼規則。"
                            modalResetResultText.classList.remove("d-none");
                            modalResetResultText2.classList.remove("d-none");
                            modalResetResultImg.src = "./images/emoCards/58.svg";
                            modalResetResultClose.classList.remove("d-none");
                            modalResetResultLink.classList.add("d-none");
                            btnResetResult.click();
                        }
                    })
                    .catch(function(error){
                        console.log(error);
                        modalResetResultTitle.textContent = "重設密碼失敗";
                        modalResetResultTitle.classList.remove("text-main");
                        modalResetResultTitle.classList.add("text-pink");
                        modalResetResultText.textContent = "很抱歉重設密碼失敗，請確認是否有輸入正確的「現在的密碼」以及「新的密碼」是否有符合設定密碼規則。"
                        modalResetResultText.classList.remove("d-none");
                        modalResetResultText2.classList.remove("d-none");
                        modalResetResultImg.src = "./images/emoCards/58.svg";
                        modalResetResultClose.classList.remove("d-none");
                        modalResetResultLink.classList.add("d-none");
                        btnResetResult.click();
                    })
                }
            })
            modalResetResultLink.addEventListener("click", function(){
                localStorage.clear();
                location.href = "login.html";
            })
        </script>
    </body>
</html>